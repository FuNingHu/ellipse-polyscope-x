#!/usr/bin/env node

const fs = require("fs");
const prefix = "@universal-robots";

const args = process.argv.slice(2);
if (args.length !== 2) {
  console.error(
    `Error: 2 parameters needed: package-lock.json file, destination folder`,
    `   or: [DEPRECATED] package.json file, destination file`,
  );
  process.exit(1);
}

const sourceFile = args[0];
const packageFile = JSON.parse(fs.readFileSync(sourceFile, "utf8"));

if (sourceFile.includes("package.json")) {
  const semVerRegExp = new RegExp(/\d+\.\d+\.\d+/);
  console.warn(
    "DEPRECATED: Using the package.json for the sbom.json is being deprecated. It is advised to use the package-lock.json instead",
  );

  const components = {
    ...deprecatedExtractComponents(packageFile.dependencies),
    ...deprecatedExtractComponents(packageFile.devDependencies),
  };

  const bom = {
    bomFormat: "Universal Robots",
    components,
  };

  function deprecatedExtractComponents(rawDependencies = {}) {
    const result = {};
    for (const [name, version] of Object.entries(rawDependencies)) {
      console.log(name, version);
      if (name.startsWith(prefix)) {
        const match = version.match(semVerRegExp);
        result[name] = match ? match[0] : version;
      }
    }
    return result;
  }

  fs.writeFileSync(args[1], JSON.stringify(bom, null, 2));
  process.exit(0);
}

const destFile = args[1] + "/sbom.json";

const components = {
  ...extractComponents(packageFile.packages),
};

const bom = {
  bomFormat: "Universal Robots",
  components,
};

fs.writeFileSync(destFile, JSON.stringify(bom, null, 2));

function extractComponents(rawDependencies = {}) {
  const result = {};
  for (const [packageName, packageInfo] of Object.entries(rawDependencies)) {
    if (packageName.includes(prefix)) {
      const simplified_name = packageName.replaceAll("node_modules/", "");
      result[simplified_name] = packageInfo.version;
    }
  }
  return result;
}

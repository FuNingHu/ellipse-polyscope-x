#!/usr/bin/env node

const fs = require("fs");
const os = require("os");
const glob = require("glob");
const path = require("path");

const args = process.argv.slice(2);

// Because the input source-files for copying can be specified in several ways (and these differ on different platforms)
// we need to explicitly take all but the last arguments and treat them as individual source-files to be copied
let sourceFiles = [];
for (let argIdx = 0; argIdx < args.length - 1; argIdx++) {
  sourceFiles[argIdx] = args[argIdx];
}

// Take the last given argument as the destination directory
const destinationFolder = setupDestinationDir(args[args.length - 1]);

try {
  for (let sourceFile of sourceFiles) {
    glob(sourceFile, (err, files) => {
      if (files.length === 0) {
        console.error(`No files matching '${sourceFile}'`);
        process.exitCode = 1;
      }
      if (err) {
        console.error(`Unable to parse source-file '${sourceFile}'`, err);
        process.exitCode = 1;
      } else {
        for (const file of files) {
          const destFile = destinationFolder.concat(path.parse(file).base);
          fs.copyFileSync(file, destFile);
          console.log(file + " was copied to " + destFile);
        }
      }
    });
  }
} catch (err) {
  console.log(
    sourceFile + " was NOT copied to " + destinationFolder + " Err:" + err,
  );
  process.exitCode = 1;
}

function setupDestinationDir(inputDir) {
  let destinationDir = inputDir.replace("~", os.homedir());
  if (!destinationDir.endsWith("/")) {
    destinationDir = `${destinationDir}/`;
  }
  if (!fs.existsSync(destinationDir)) {
    fs.mkdirSync(destinationDir, { recursive: true });
  }
  return destinationDir;
}

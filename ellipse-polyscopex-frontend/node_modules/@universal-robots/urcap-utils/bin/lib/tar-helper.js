const fs = require("fs");
const tar = require("tar");

/**
 * Stream text-contents of single file from tarball
 * @param tarFile input tarball
 * @param fileName the file to stream
 * @returns {Promise<string>}
 */
function readTextFileFromTar(tarFile, fileName) {
  return new Promise((resolve, reject) => {
    let result = [];
    fs.createReadStream(tarFile)
      .pipe(
        new tar.Parse({
          // Parse the input tar, only look at given filename
          filter: (path, entry) => path === fileName,
        }),
      )
      .on("entry", (entry) => {
        // Read the data of the file and add to result
        entry.on("data", (chunk) => result.push(Buffer.from(chunk)));
        entry.on("error", (err) => reject(err));
      })
      .on("end", () => {
        // Return result array as a string
        resolve(Buffer.concat(result).toString("utf8"));
      });
  });
}

/**
 * Create tarball from directory
 * @param inputDirectory the directory to package
 * @param outputFile the path of the resulting tarfile
 * @param files the (potentially) ordered list of files to package from the inputDirectory
 */
function createTarFile(inputDirectory, outputFile, files) {
  tar.create(
    { file: outputFile, cwd: inputDirectory, sync: true, gzip: true },
    files,
  );
}

module.exports = { readTextFileFromTar, createTarFile };

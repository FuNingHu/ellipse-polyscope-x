#!/usr/bin/env node
const manifestHelper = require("./lib/manifest-helper");
const fs = require('fs');
const yaml = require("js-yaml");
const skipValidation = process.env.skip_validation;
const args = process.argv.slice(2);
const manifestFilePath = args[0];
const schemaPath = args[1];

if(skipValidation){
  return;
}

if (!manifestFilePath || !schemaPath) {
    console.error('Error: Please provide both the manifest.yaml file path and schema as an argument. Or ');
    console.error("Usage: node validate-manifest.js '<manifest.yaml>' '<manifest-spec_file_or_url' ");
    process.exit(1);
}

// Fetch from URL or file
const schemaAsJson = manifestHelper.fetchJsonSync(schemaPath);

// Check if manifest file exists
if (!fs.existsSync(manifestFilePath)) {
    console.error(`Error: Manifest file not found: ${manifestFilePath}`);
    process.exit(1);
}

const manifestAsYaml = yaml.load(fs.readFileSync(manifestFilePath));
let validateResponse = manifestHelper.validate(schemaAsJson, manifestAsYaml);
if (!validateResponse.success) {
    console.log(validateResponse.message);
    console.log(validateResponse);
    console.log("(Note: It is possible to skip the manifest validation by prepending 'skip_validation=true'. Fx 'skip_validation=true npm run build')");
    process.exit(1);
}
#!/usr/bin/env node

const fs = require("fs");
const manifestHelper = require("./lib/manifest-helper.js");
const tarHelper = require("./lib/tar-helper");

const MANIFEST = "manifest.yaml";

const orderFiles = (dir) => {
  const files = fs.readdirSync(dir);

  return files
    .map((fileName) => ({ name: fileName }))
    .sort((a, b) => {
      // Always put manifest file first, sort the rest alphabetically
      if (a.name === MANIFEST) {
        return -1;
      } else if (b.name === MANIFEST) {
        return 1;
      }
      return b.name - a.name;
    })
    .map((file) => file.name);
};

function getOutputFileName() {
  const urcap = manifestHelper.readManifestFile(
    `${inputDirectory}/${MANIFEST}`,
  );
  const version = urcap.version.replace(/^v/, "");
  return `${outputDirectory}/${urcap.urcapId}-${version}.urcapx`;
}

function createUrcapXFile() {
  if (!fs.existsSync(outputDirectory)) {
    fs.mkdirSync(outputDirectory, { recursive: true });
  }

  const outputFile = getOutputFileName();
  const filesInOrder = orderFiles(inputDirectory);
  try {
    tarHelper.createTarFile(inputDirectory, outputFile, filesInOrder);
    console.log(`Saved ${outputFile}`);
  } catch (error) {
    console.error("Unable to package URCapX", error);
  }
}

const args = process.argv.slice(2);

const inputDirectory = args[0];
const outputDirectory = args[1];

createUrcapXFile();

#!/usr/bin/env node
const glob = require("glob");
const manifestHelper = require("./lib/manifest-helper");
const urserviceHelper = require("./lib/urservice-helper");

function parseArguments() {
    let skipSchemaValidation = process.env.skip_validation || false;
    const args = process.argv.slice(2);

    const fileInput = args[0];
    if (!fileInput) {
        console.log(`The first argument must be a path to the URCapx file (`);
        process.exit(1);
    }
    const fileMatches = glob.sync(fileInput);
    if (fileMatches.length < 1) {
        console.log(`URCap file ${fileInput} not found`);
        process.exit(1);
    }
    if (fileMatches.length > 1) {
        console.log(`Multiple files match ${fileInput}`);
        process.exit(1);
    }

    const urcapxFile = fileMatches[0];
    const urcapPromise = manifestHelper.readManifestFileFromUrcap(urcapxFile);
    const forceReplace = args.includes('--force-replace');
    const schemaPath = args[1];
    if (!schemaPath) {
        console.log('\x1b[33m%s\x1b[0m', '⚠️  DEPRECATION WARNING');
        console.log('\x1b[33m%s\x1b[0m', 'Running \'npm run install-urcap\' without 2 arguments [urcapx-glob] [manifest-spec-path_or_url] is deprecated.');
        console.log('\x1b[36m%s\x1b[0m', 'Please use \'npm run install-urcap [urcapx-glob] [manifest-spec-path_or_url]\' instead.');
        skipSchemaValidation = true;
    }
    return {urcapxFile, urcapPromise, forceReplace, skipSchemaValidation, schemaPath};
}

const {urcapxFile, urcapPromise, forceReplace, skipSchemaValidation, schemaPath} = parseArguments();
urcapPromise.then((urcap) => {
    if (!skipSchemaValidation) {
        // Only perform validation if not skipping

        // Fetch from URL or file
        const schemaAsJson = manifestHelper.fetchJsonSync(schemaPath);

        let manifestFileFromUrcap = manifestHelper.getManifestFileFromUrcapAsYaml(urcapxFile);
        manifestFileFromUrcap.then(
            (manifest) => {
                let validateResponse = manifestHelper.validate(schemaAsJson, manifest);
                if (!validateResponse.success) {
                    console.log(validateResponse.message);
                    console.log(validateResponse);
                    console.log("(Note: It is possible to skip the manifest validation by prepending 'skip_validation=true'. Fx 'skip_validation=true npm run install-urcap')");
                    return false;
                }
                // Proceed with installation after successful validation
                proceedWithInstallation();
            }
        );
    } else {
        // Skip validation and proceed directly to installation
        proceedWithInstallation();
    }

    function proceedWithInstallation() {
        urserviceHelper
            .installOrUpdateUrcap(
                urcapxFile,
                urcap.vendorId,
                urcap.urcapId,
                forceReplace,
            )
            .then(
                (value) => {
                    console.log("URCap Succesfully Installed!");
                    console.log(`\tVendorId: ${value.metadata.id.vendorID}`);
                    console.log(`\tUrcapId: ${value.metadata.id.urcapID}`);
                },
                (reason) => {
                    console.log(`Failed installing urcap:`);
                    console.log(`\tMessage: ${reason.message}`);
                    console.log(`\tDetails: ${reason.details}`);
                }
            );
    }
});
